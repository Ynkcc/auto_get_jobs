name: Debug Release Builder with tmate

on:
  workflow_dispatch:  # å¿…é¡»æ‰‹åŠ¨è§¦å‘ä»¥ä¾¿è°ƒè¯•
    inputs:
      enable_tmate:
        description: 'Enable tmate debug session'
        required: false
        default: 'false'
        type: boolean
      source_run_id:
        description: 'Source workflow run ID'
        required: true
        type: string

jobs:
  package-release:
    runs-on: ubuntu-latest
    steps:
      # æ­¥éª¤1ï¼šè·å–æŒ‡å®šè¿è¡ŒIDçš„æ„å»ºäº§ç‰©
      - name: Download Artifacts from Other Workflow
        uses: actions/download-artifact@v4
        with:
          repository: ${{ github.repository }}  # æ ¼å¼ï¼šowner/repo
          run-id: ${{ inputs.source_run_id }}
          github-token: ${{ secrets.GH_PAT }}  # éœ€è¦å…·æœ‰actions:readæƒé™çš„PAT
          path: artifacts
         # name: nuitka_build

      # æ­¥éª¤2ï¼šå¯åŠ¨ç¬¬ä¸€æ¬¡è°ƒè¯•ä¼šè¯ï¼ˆæŸ¥çœ‹åŸå§‹æ–‡ä»¶ï¼‰
      - name: Debug Artifacts (Pre-Package)
        if: ${{ inputs.enable_tmate }}
        uses: mxschmitt/action-tmate@v3
        timeout-minutes: 15
        with:
          limit-access-to-organization: true
          prompt: "ğŸ•µï¸ æ£€æŸ¥åŸå§‹æ„å»ºäº§ç‰© | è¾“å…¥ 'exit' ç»§ç»­å·¥ä½œæµ"
          session-name: pre-package-debug

      # æ­¥éª¤3ï¼šå‹ç¼©æ‰“åŒ…å¤„ç†
      - name: Package Artifacts
        run: |
          mkdir -p packaged
          find artifacts -maxdepth 1 -mindepth 1 -type d | while read dir; do
            base=$(basename "$dir")
            echo "Compressing: $base"
            zip -r "packaged/${base}.zip" "$dir"
          done

      # æ­¥éª¤4ï¼šå¯åŠ¨ç¬¬äºŒæ¬¡è°ƒè¯•ä¼šè¯ï¼ˆéªŒè¯å‹ç¼©åŒ…ï¼‰
      - name: Debug Packages (Pre-Release)
        if: ${{ inputs.enable_tmate }}
        uses: mxschmitt/action-tmate@v3
        timeout-minutes: 15
        with:
          limit-access-to-organization: true
          prompt: "ğŸ” éªŒè¯å‹ç¼©åŒ…å†…å®¹ | è¾“å…¥ 'exit' ç»§ç»­å‘å¸ƒ"
          session-name: pre-release-debug
          run: |
            echo "=== å‹ç¼©åŒ…åˆ—è¡¨ ==="
            ls -lh packaged
            echo "\n=== ç¤ºä¾‹æ–‡ä»¶æ ¡éªŒ ==="
            unzip -l packaged/*.zip | head -n 10

      # æ­¥éª¤5ï¼šåˆ›å»ºè°ƒè¯•ç‰ˆRelease
      - name: Create Debug Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: debug-${{ github.run_id }}
          name: "Debug Builds (${{ github.run_id }})"
          body: |
            äº¤äº’å¼è°ƒè¯•æ„å»ºç‰ˆæœ¬
            - è°ƒè¯•ä¼šè¯æ¬¡æ•°ï¼š${{ steps.tmate.outputs.session_count }}
            - æœ€ç»ˆæ–‡ä»¶æ ¡éªŒï¼š
              ```sh
              $(sha256sum packaged/*.zip)
              ```
          files: packaged/*.zip
          draft: true
          prerelease: true
